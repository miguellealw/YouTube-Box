services:
  # Test database - isolated from production
  test-db:
    image: postgres:latest
    env_file:
      - .env.test
    environment:
      - POSTGRES_USER=${TEST_DB_USER:-postgres}
      - POSTGRES_PASSWORD=${TEST_DB_PASSWORD:-test_password}
      - POSTGRES_DB=${TEST_DB_NAME:-test_db}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TEST_DB_USER:-postgres}"]
      interval: 2s
      timeout: 3s
      retries: 5
    networks:
      - test-network

  # Test runner service
  test:
    build:
      context: ./YG-server
      dockerfile: Dockerfile.test
    depends_on:
      test-db:
        condition: service_healthy
    env_file:
      - .env.test
    environment:
      - FLASK_ENV=testing
      - TEST_DATABASE_URI=postgresql://${TEST_DB_USER:-postgres}:${TEST_DB_PASSWORD:-test_password}@test-db:5432/${TEST_DB_NAME:-test_db}
      - SECRET_KEY=${TEST_SECRET_KEY:-test-secret-key}
      - FLASK_APP=youtubebox.py
      - DATABASE_URI=postgresql://${TEST_DB_USER:-postgres}:${TEST_DB_PASSWORD:-test_password}@test-db:5432/${TEST_DB_NAME:-test_db}
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
