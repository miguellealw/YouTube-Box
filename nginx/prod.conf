# Cache zone for static assets
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=STATIC:10m inactive=7d use_temp_path=off;

# Redirect HTTP to HTTPS
server {
	listen 80 default_server;
	listen [::]:80 default_server;
	server_name _;
	return 301 https://$host$request_uri;
}

server {
	listen 443 ssl http2 default_server;
	listen [::]:443 ssl http2 default_server;

	# SSL config (ensure ssl.conf exists or add certs directly)
	include /config/nginx/ssl.conf;

	# Static assets with caching
	location ~* \.(?:css|js|jpe?g|png|gif|ico|webp|mp4|webm|svg|ttf|woff2?)$ {
		proxy_pass http://client:3000;
		expires 7d;
		access_log off;
	}

	location / {
		proxy_pass http://client:3000;
		proxy_redirect default;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Host $server_name;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	location /api/v1.0 {
		proxy_pass http://server:5000;
		proxy_redirect default;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Host $server_name;
		proxy_set_header X-Forwarded-Proto $scheme;
	}
}
